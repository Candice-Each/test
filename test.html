<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations & Maintenance Dashboard</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1a3c6e;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-bg: #f5f9fa;
            --dark-text: #333;
            --light-text: #fff;
            --sidebar-width: 70px;
            --chart-blue: #1a3c6e;
            --chart-light-blue: #3498db;
            --chart-teal: #2980b9;
            --chart-dark-teal: #1c6ea4;
            --chart-light-teal: #4da8da;
            --chart-gray: #90a4ae;
            --chart-green: #8aa46d;
            --chart-yellow: #ecbc6f;
            --chart-red: rgb(231, 127, 127);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: var(--dark-text);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: width 0.3s ease;
        }

        .logo {
            padding: 0 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .logo i {
            font-size: 28px;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            padding: 15px;
            text-align: center;
        }

        .nav-links li.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-links a {
            color: var(--light-text);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
        }

        .nav-links i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-links span {
            display: none;
        }

        /* Main content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-bell {
            position: relative;
            font-size: 20px;
            color: #666;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--chart-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-display {
            font-size: 16px;
            color: #666;
        }

        /* Section */
        .section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }

        /* Map section */
        .map-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .region-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .region-selector label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .region-selector select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            min-width: 200px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .date-selector label {
            font-weight: 600;
            color: var(--primary-color);
            white-space: nowrap;
        }

        .date-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            width: 150px;
        }

        .map-container {
            display: flex;
            gap: 20px;
        }

        .map {
            flex: 1;
            height: 500px;
            background-color: #e9f5e9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-width: 300px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .building-list {
            flex: 0 0 30%;
            background-color: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            max-height: 500px;
            min-width: 250px;
        }

        .data-title {
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .building-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background-color: white;
            border-radius: 6px;
            margin-bottom: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .building-item.selected {
            background-color: #e8f4fd;
            border-left: 3px solid var(--accent-color);
        }

        .building-checkbox {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .building-info {
            flex: 1;
        }

        .building-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            color: var(--primary-color);
        }

        .building-location {
            font-size: 12px;
            color: #666;
        }

        /* Operations section */
        .operations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        /* Dashboard cards - Grid layout */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .card.dragging {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .card h3 {
            margin-bottom: 15px;
            color: var(--dark-text);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h3 i {
            font-size: 18px;
            color: var(--primary-color);
        }

        .metric-large {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .positive {
            color: var(--chart-green);
        }

        .negative {
            color: var(--chart-red);
        }

        /* Charts layout - Grid layout */
        .top-charts-row {
            display: grid;
            grid-template-columns: 1.2fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .bottom-charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .chart-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .chart-card.dragging {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .chart-title {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-title i {
            font-size: 18px;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .compact-chart-container {
            position: relative;
            height: 220px;
        }

        .expiring-leases {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .lease-item {
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .lease-value {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .lease-label {
            font-size: 11px;
            color: #666;
            line-height: 1.2;
        }

        /* Property types bar chart */
        .property-bar-container {
            margin-top: 20px;
        }

        .property-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .property-bar-label {
            width: 150px;
            font-weight: 500;
            font-size: 14px;
        }

        .property-bar-values {
            width: 80px;
            text-align: right;
            font-size: 14px;
            margin-left: 10px;
        }

        .property-bar-chart {
            flex: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .property-bar-fill {
            height: 100%;
            background-color: var(--chart-teal);
            border-radius: 10px;
        }

        /* Semi-circle doughnut chart */
        .semi-doughnut-container {
            position: relative;
            width: 100%;
            height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .semi-doughnut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .semi-doughnut-center-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .semi-doughnut-center-label {
            font-size: 12px;
            color: #666;
        }

        /* NPS gauge chart */
        .nps-gauge-container {
            position: relative;
            width: 100%;
            height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .nps-gauge-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .nps-gauge-center-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .nps-gauge-center-label {
            font-size: 12px;
            color: #666;
        }

        /* Top right cards */
        .top-right-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .top-right-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .top-right-card.dragging {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        /* Utilities & Energy section */
        .utilities-energy-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .utilities-chart {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .utilities-chart.dragging {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .energy-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .energy-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .energy-card.dragging {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .energy-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .energy-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .energy-subvalue {
            font-size: 14px;
            color: #888;
        }

        /* Lease expiry table */
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            width: 100%;
        }

        .lease-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed;
        }

        .lease-table th,
        .lease-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .lease-table th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .lease-table tr:hover {
            background-color: #f9f9f9;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-options {
            background-color: var(--chart-light-teal);
            color: white;
        }

        .btn-details {
            background-color: var(--chart-teal);
            color: white;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: white;
            color: var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:hover:not(:disabled) {
            background-color: #f1f1f1;
        }

        .pagination button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        /* Drag placeholder styles */
        .drag-placeholder {
            background-color: rgba(26, 60, 110, 0.1);
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            height: 100%;
            width: 100%;
            transition: all 0.2s;
        }

        /* Drag indicator */
        .drag-indicator {
            position: absolute;
            background-color: var(--primary-color);
            border-radius: 2px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0.7;
        }

        .drag-indicator.horizontal {
            height: 4px;
            width: 100%;
        }

        .drag-indicator.vertical {
            width: 4px;
            height: 100%;
        }

        /* Drag container styles */
        .drag-container {
            position: relative;
        }

        /* Responsive design */
        @media (max-width: 1400px) {
            .map-container {
                flex-direction: column;
            }

            .building-list {
                flex: 1;
                max-width: 100%;
            }

            .top-charts-row {
                grid-template-columns: 1fr;
            }

            .bottom-charts-grid {
                grid-template-columns: 1fr;
            }

            .utilities-energy-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 60px;
            }

            .main-content {
                margin-left: 60px;
            }
        }

        @media (max-width: 992px) {
            .map-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .top-charts-row {
                grid-template-columns: 1fr;
            }

            .bottom-charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 50px;
            }

            .main-content {
                margin-left: 50px;
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .section {
                padding: 15px;
            }

            .chart-container {
                height: 250px;
            }

            .compact-chart-container {
                height: 180px;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .nav-links {
                display: flex;
                justify-content: space-around;
            }

            .nav-links li {
                padding: 10px;
            }

            .main-content {
                margin-left: 0;
            }

            .map {
                height: 400px;
            }

            .building-list {
                max-height: 300px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .top-charts-row {
                grid-template-columns: 1fr;
            }

            .bottom-charts-grid {
                grid-template-columns: 1fr;
            }

            .utilities-energy-section {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 200px;
            }

            .compact-chart-container {
                height: 150px;
            }
        }

        /* 拖拽相关样式 */
        .dragging {
            z-index: 1000 !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3) !important;
            opacity: 0.9;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card, .chart-card, .top-right-card, .utilities-chart, .energy-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: move;
        }

        .card:hover, .chart-card:hover, .top-right-card:hover, .utilities-chart:hover, .energy-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-leaf"></i>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> <span>Locations</span></a></li>
                <li><a href="#"><i class="fas fa-chart-line"></i> <span>Emissions</span></a></li>
                <li><a href="#"><i class="fas fa-leaf"></i> <span>Energy</span></a></li>
                <li><a href="#"><i class="fas fa-recycle"></i> <span>Waste</span></a></li>
                <li><a href="#"><i class="fas fa-bullseye"></i> <span>Targets</span></a></li>
                <li><a href="#"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1>Operations & Maintenance Performance</h1>
                    <div class="date-display">November 2025</div>
                </div>
                <div class="header-right">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar">JD</div>
                        <span>John Doe</span>
                    </div>
                </div>
            </div>

            <!-- Map section -->
            <div class="section">
                <h2 class="section-title">Locations</h2>
                <div class="map-controls">
                    <div class="region-selector">
                        <label for="region-select">Select Region:</label>
                        <select id="region-select">
                            <option value="all">All Regions</option>
                            <option value="hongkong">Hong Kong</option>
                            <option value="mainland">Mainland China</option>
                            <option value="europe">Europe</option>
                            <option value="usa">United States</option>
                        </select>
                    </div>
                    <div class="date-selector">
                        <label for="start-date">Start Date:</label>
                        <input type="date" id="start-date" value="2023-11-12">
                        <label for="end-date">End Date:</label>
                        <input type="date" id="end-date" value="2024-11-12">
                    </div>
                </div>
                <div class="map-container">
                    <div class="map">
                        <div id="map"></div>
                    </div>
                    <div class="building-list">
                        <div class="data-title">
                            <h3>Building List</h3>
                            <span id="total-buildings">0 buildings</span>
                        </div>
                        <div id="building-list-container">
                            <!-- Building list will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations section -->
            <div class="section">
                <div class="operations-header">
                    <h2 class="section-title">Operations & Maintenance</h2>
                    <div class="date-display">November 2025</div>
                </div>

                <!-- Dashboard cards -->
                <div class="dashboard drag-container" id="dashboard">
                    <div class="card" draggable="true" id="revenue-card">
                        <h3><i class="fas fa-dollar-sign"></i> Total Revenue</h3>
                        <div class="metric-large" id="revenue-value">$0</div>
                        <div class="metric-change" id="revenue-change">0% YoY</div>
                    </div>

                    <div class="card" draggable="true" id="profit-card">
                        <h3><i class="fas fa-chart-line"></i> Total Profit</h3>
                        <div class="metric-large" id="profit-value">$0</div>
                        <div class="metric-change" id="profit-change">0 YoY</div>
                    </div>

                    <div class="card" draggable="true" id="nps-card">
                        <h3><i class="fas fa-star"></i> Net Promoter Score</h3>
                        <div class="nps-gauge-container">
                            <canvas id="npsGaugeChart"></canvas>
                            <div class="nps-gauge-center">
                                <div class="nps-gauge-center-value" id="nps-value">0</div>
                                <div class="nps-gauge-center-label">NPS Score</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" draggable="true" id="occupancy-card">
                        <h3><i class="fas fa-bed"></i> Occupancy Rate</h3>
                        <div class="metric-large" id="occupancy-value">0%</div>
                        <div class="metric-change" id="occupancy-change">0%</div>
                    </div>
                </div>

                <!-- Top row charts -->
                <div class="top-charts-row drag-container" id="top-charts-row">
                    <div class="chart-card" draggable="true" id="leases-expiring-card">
                        <div class="chart-title"><i class="fas fa-calendar-times"></i> Leases are Expiring</div>
                        <div class="semi-doughnut-container">
                            <canvas id="leasesExpiringChart"></canvas>
                            <div class="semi-doughnut-center">
                                <div class="semi-doughnut-center-value" id="leases-expiring-total">46</div>
                                <div class="semi-doughnut-center-label">Units</div>
                            </div>
                        </div>
                        <div class="expiring-leases" id="expiring-leases">
                            <!-- Expiring leases will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="chart-card" draggable="true" id="renewed-card">
                        <div class="chart-title"><i class="fas fa-file-contract"></i> Number of Renewed Contracts</div>
                        <div class="chart-container">
                            <canvas id="renewedChart"></canvas>
                        </div>
                    </div>

                    <div class="top-right-cards drag-container" id="top-right-cards">
                        <div class="top-right-card" draggable="true" id="new-leads-card">
                            <h3><i class="fas fa-users"></i> No. of New Leads</h3>
                            <div class="metric-large" id="new-leads">0</div>
                            <div class="metric-change" id="new-leads-change">0 YoY</div>
                        </div>

                        <div class="top-right-card" draggable="true" id="lease-duration-card">
                            <h3><i class="fas fa-clock"></i> Average Lease Duration</h3>
                            <div class="metric-large" id="lease-duration">0 months</div>
                        </div>
                    </div>
                </div>

                <!-- Bottom grid charts -->
                <div class="bottom-charts-grid drag-container" id="bottom-charts-grid">
                    <div class="chart-card" draggable="true" id="income-cost-card">
                        <div class="chart-title"><i class="fas fa-money-bill-wave"></i> Rental Income vs Operation Cost
                        </div>
                        <div class="chart-container">
                            <canvas id="incomeCostChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card" draggable="true" id="occupancy-chart-card">
                        <div class="chart-title"><i class="fas fa-home"></i> Occupancy vs Vacancy</div>
                        <div class="chart-container">
                            <canvas id="occupancyChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card" draggable="true" id="rented-month-card">
                        <div class="chart-title"><i class="fas fa-chart-bar"></i> Properties Rented by Month</div>
                        <div class="chart-container">
                            <canvas id="rentedByMonthChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card" draggable="true" id="property-types-card">
                        <div class="chart-title"><i class="fas fa-building"></i> Properties Rented by Type</div>
                        <div class="property-bar-container" id="property-types">
                            <!-- Property types will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Utilities & Energy section -->
                <div class="utilities-energy-section drag-container" id="utilities-energy-section">
                    <div class="utilities-chart" draggable="true" id="utilities-chart">
                        <div class="chart-title"><i class="fas fa-tools"></i> Utilities & Services Cost</div>
                        <div class="chart-container">
                            <canvas id="utilitiesChart"></canvas>
                        </div>
                    </div>

                    <div class="energy-cards drag-container" id="energy-cards">
                        <div class="energy-card" draggable="true" id="energy-optimization-card">
                            <div class="energy-title">Energy Optimization by AI</div>
                            <div class="energy-value" id="energy-optimization">0 kWh</div>
                            <div class="energy-subvalue" id="energy-optimization-change"> </div>
                        </div>

                        <div class="energy-card" draggable="true" id="energy-saving-card">
                            <div class="energy-title">Accumulative Energy Cost Saving</div>
                            <div class="energy-value" id="energy-saving">$ 0</div>
                            <div class="energy-subvalue" id="energy-saving-change"> </div>
                        </div>
                    </div>
                </div>

                <!-- Lease expiry timeline table -->
                <div class="chart-card" draggable="true" id="lease-table-card">
                    <div class="chart-title"><i class="fas fa-table"></i> Lease Expiry Timeline</div>
                    <div class="table-container">
                        <table class="lease-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Order Date</th>
                                    <th>Phone Number</th>
                                    <th>Location</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lease-table-body">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>

                        <div class="pagination" id="pagination-controls">
                            <!-- Pagination controls will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Main application logic -->
    <script>
        // 拖拽排序类
        class Draggable {
            constructor(options) {
                this.containerElement = options.element;
                this.rectList = [];
                this.drag = { 
                    element: null, 
                    index: 0, 
                    firstIndex: 0,
                    startX: 0,
                    startY: 0
                };
                this.clone = { element: null, x: 0, y: 0 };
                this.diff = { x: 0, y: 0 };
                this.lastPointerMove = { x: 0, y: 0 };
                this.isPointerDown = false;
                this.referenceElement = null;
                
                this.init();
            }

            init() {
                this.getRectList();
                this.bindEventListener();
            }

            getRectList() {
                this.rectList.length = 0;
                const children = Array.from(this.containerElement.children).filter(child => 
                    child.classList.contains('card') || 
                    child.classList.contains('chart-card') || 
                    child.classList.contains('top-right-card') || 
                    child.classList.contains('utilities-chart') || 
                    child.classList.contains('energy-card')
                );
                
                for (const item of children) {
                    this.rectList.push(item.getBoundingClientRect());
                }
            }

            bindEventListener() {
                this.containerElement.addEventListener('pointerdown', this.onPointerDown.bind(this));
                document.addEventListener('pointermove', this.onPointerMove.bind(this));
                document.addEventListener('pointerup', this.onPointerUp.bind(this));
            }

            onPointerDown(e) {
                // 只处理可拖拽元素
                const target = e.target.closest('.card, .chart-card, .top-right-card, .utilities-chart, .energy-card');
                if (!target || !target.draggable) return;
                
                e.preventDefault();
                this.isPointerDown = true;
                
                this.drag.element = target;
                this.drag.element.classList.add('dragging');
                
                // 获取初始位置和索引
                const children = Array.from(this.containerElement.children).filter(child => 
                    child.classList.contains('card') || 
                    child.classList.contains('chart-card') || 
                    child.classList.contains('top-right-card') || 
                    child.classList.contains('utilities-chart') || 
                    child.classList.contains('energy-card')
                );
                
                const index = children.indexOf(this.drag.element);
                this.drag.index = index;
                this.drag.firstIndex = index;
                
                // 记录指针位置
                this.lastPointerMove.x = e.clientX;
                this.lastPointerMove.y = e.clientY;
                
                // 记录元素初始位置
                const rect = this.drag.element.getBoundingClientRect();
                this.drag.startX = rect.left;
                this.drag.startY = rect.top;
                
                // 为所有子元素添加过渡效果
                for (const item of children) {
                    item.style.transition = 'transform 0.3s ease';
                }
            }

            onPointerMove(e) {
                if (!this.isPointerDown || !this.drag.element) return;
                
                // 计算移动距离
                this.diff.x = e.clientX - this.lastPointerMove.x;
                this.diff.y = e.clientY - this.lastPointerMove.y;

                this.lastPointerMove.x = e.clientX;
                this.lastPointerMove.y = e.clientY;

                // 更新拖拽元素位置
                const currentTransform = this.getTransformValues(this.drag.element.style.transform);
                const newX = currentTransform.x + this.diff.x;
                const newY = currentTransform.y + this.diff.y;
                
                this.drag.element.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
                
                // 碰撞检测和元素位置调整
                this.checkCollision(e.clientX, e.clientY);
            }

            onPointerUp(e) {
                if (!this.isPointerDown) return;
                
                this.isPointerDown = false;
                
                // 插入到新位置
                if (this.referenceElement !== null && this.drag.element) {
                    this.containerElement.insertBefore(this.drag.element, this.referenceElement);
                }
                
                // 重置样式
                if (this.drag.element) {
                    this.drag.element.classList.remove('dragging');
                    this.drag.element.style.transform = 'translate3d(0px, 0px, 0px)';
                }
                
                // 重置所有元素的transform
                const children = Array.from(this.containerElement.children).filter(child => 
                    child.classList.contains('card') || 
                    child.classList.contains('chart-card') || 
                    child.classList.contains('top-right-card') || 
                    child.classList.contains('utilities-chart') || 
                    child.classList.contains('energy-card')
                );
                
                for (const item of children) {
                    item.style.transition = 'none';
                    item.style.transform = 'translate3d(0px, 0px, 0px)';
                }
                
                // 重置状态
                this.drag.element = null;
                this.referenceElement = null;
                
                // 更新位置信息
                setTimeout(() => {
                    this.getRectList();
                }, 50);
            }

            getTransformValues(transform) {
                if (!transform || transform === 'none') return { x: 0, y: 0 };
                
                const matrix = transform.match(/matrix\(([^)]+)\)/);
                if (matrix) {
                    const values = matrix[1].split(', ');
                    return {
                        x: parseFloat(values[4]) || 0,
                        y: parseFloat(values[5]) || 0
                    };
                }
                
                const translate = transform.match(/translate3d\(([^)]+)\)/);
                if (translate) {
                    const values = translate[1].split(', ');
                    return {
                        x: parseFloat(values[0]) || 0,
                        y: parseFloat(values[1]) || 0
                    };
                }
                
                return { x: 0, y: 0 };
            }

            checkCollision(x, y) {
                const children = Array.from(this.containerElement.children).filter(child => 
                    child.classList.contains('card') || 
                    child.classList.contains('chart-card') || 
                    child.classList.contains('top-right-card') || 
                    child.classList.contains('utilities-chart') || 
                    child.classList.contains('energy-card')
                );
                
                let newIndex = this.drag.index;
                
                for (let i = 0; i < this.rectList.length; i++) {
                    if (i !== this.drag.index &&
                        x > this.rectList[i].left && x < this.rectList[i].right &&
                        y > this.rectList[i].top && y < this.rectList[i].bottom) {
                        
                        newIndex = i;
                        break;
                    }
                }
                
                if (newIndex !== this.drag.index) {
                    this.moveElements(this.drag.index, newIndex);
                    this.drag.index = newIndex;
                }
            }

            moveElements(fromIndex, toIndex) {
                const children = Array.from(this.containerElement.children).filter(child => 
                    child.classList.contains('card') || 
                    child.classList.contains('chart-card') || 
                    child.classList.contains('top-right-card') || 
                    child.classList.contains('utilities-chart') || 
                    child.classList.contains('energy-card')
                );
                
                // 重置所有元素的transform（除了拖拽的元素）
                for (let i = 0; i < children.length; i++) {
                    if (i !== this.drag.firstIndex) {
                        children[i].style.transform = 'translate3d(0px, 0px, 0px)';
                    }
                }
                
                if (toIndex < fromIndex) {
                    // 向左移动
                    for (let i = toIndex; i < fromIndex; i++) {
                        if (i !== this.drag.firstIndex) {
                            const x = this.rectList[i + 1].left - this.rectList[i].left;
                            const y = this.rectList[i + 1].top - this.rectList[i].top;
                            children[i].style.transform = `translate3d(${x}px, ${y}px, 0)`;
                        }
                    }
                    this.referenceElement = children[toIndex];
                } else if (toIndex > fromIndex) {
                    // 向右移动
                    for (let i = fromIndex + 1; i <= toIndex; i++) {
                        if (i !== this.drag.firstIndex) {
                            const x = this.rectList[i - 1].left - this.rectList[i].left;
                            const y = this.rectList[i - 1].top - this.rectList[i].top;
                            children[i].style.transform = `translate3d(${x}px, ${y}px, 0)`;
                        }
                    }
                    this.referenceElement = toIndex < children.length - 1 ? children[toIndex + 1] : null;
                }
            }
        }

        // 初始化拖拽功能
        function initEnhancedDragAndDrop() {
            const containers = document.querySelectorAll('.drag-container');
            
            containers.forEach(container => {
                new Draggable({
                    element: container
                });
            });
        }

        // DOM elements
        const regionSelect = document.getElementById('region-select');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const totalBuildings = document.getElementById('total-buildings');
        const buildingListContainer = document.getElementById('building-list-container');
        const leaseTableBody = document.getElementById('lease-table-body');
        const paginationControls = document.getElementById('pagination-controls');

        // Energy metrics elements
        const energyOptimization = document.getElementById('energy-optimization');
        const energyOptimizationChange = document.getElementById('energy-optimization-change');
        const energySaving = document.getElementById('energy-saving');
        const energySavingChange = document.getElementById('energy-saving-change');

        // Operations metrics elements
        const revenueValue = document.getElementById('revenue-value');
        const revenueChange = document.getElementById('revenue-change');
        const profitValue = document.getElementById('profit-value');
        const profitChange = document.getElementById('profit-change');
        const npsValue = document.getElementById('nps-value');
        const occupancyValue = document.getElementById('occupancy-value');
        const occupancyChange = document.getElementById('occupancy-change');
        const newLeads = document.getElementById('new-leads');
        const newLeadsChange = document.getElementById('new-leads-change');
        const leaseDuration = document.getElementById('lease-duration');
        const leasesExpiringTotal = document.getElementById('leases-expiring-total');

        // Chart instances
        let incomeCostChart, occupancyChart, rentedByMonthChart, renewedChart, leasesExpiringChart, npsGaugeChart, utilitiesChart;

        // Selected buildings
        let selectedBuildings = [];
        let map;
        let markers = {};

        // Table pagination
        let currentPage = 1;
        const itemsPerPage = 4;

        // Sample data (for demonstration)
        const buildingData = {
            'building-a': {
                name: 'Building A',
                location: 'New York, NY',
                region: 'usa',
                coordinates: [40.7128, -74.0060],
                energyOptimization: 12500,
                energySaving: 15000,
                revenue: 250000,
                revenueChange: 5.2,
                profit: 120000,
                profitChange: 8000,
                nps: 75,
                occupancy: 85,
                occupancyChange: 2.5,
                incomeData: [20000, 22000, 21000, 23000, 24000, 25000, 26000, 27000, 28000, 29000, 30000, 31000],
                costData: [12000, 12500, 13000, 13500, 14000, 14500, 15000, 15500, 16000, 16500, 17000, 17500],
                occupancyData: { occupied: 85, vacant: 15 },
                rentedByMonth: [10, 12, 15, 18, 20, 22, 25, 28, 30, 32, 35, 38],
                availableByMonth: [5, 4, 3, 2, 2, 1, 1, 1, 0, 0, 0, 0],
                renewedContracts: [2, 3, 1, 4, 2, 3, 5, 4, 3, 2, 4, 3],
                propertyTypes: [
                    { name: "Big Studio", rented: 5, total: 8 },
                    { name: "Middle Studio", rented: 8, total: 10 },
                    { name: "Smaller Studio", rented: 12, total: 15 },
                    { name: "3 Bed Apartment", rented: 3, total: 5 },
                    { name: "2 Bed Apartment", rented: 7, total: 10 },
                    { name: "1 Bed Apartment", rented: 10, total: 12 }
                ],
                expiringLeases: [
                    { value: "$12,500", label: "< 30 Days", units: 5 },
                    { value: "$18,750", label: "31-70 Days", units: 8 },
                    { value: "$15,000", label: "61-90 Days", units: 6 }
                ],
                expiringLeasesChart: [
                    { label: "< 30 Days", value: 5, cost: 12500 },
                    { label: "31-70 Days", value: 8, cost: 18750 },
                    { label: "61-90 Days", value: 6, cost: 15000 }
                ],
                newLeads: 45,
                newLeadsChange: 5,
                leaseDuration: 24,
                utilitiesData: {
                    electricity: [5000, 5200, 4800, 5100, 5300, 5500, 5700, 5900, 6100, 6300, 6500, 6700],
                    gas: [2000, 2100, 1900, 2050, 2200, 2300, 2400, 2500, 2600, 2700, 2800, 2900],
                    water: [800, 850, 780, 820, 860, 900, 940, 980, 1020, 1060, 1100, 1140],
                    property: [3000, 3100, 2900, 3050, 3200, 3300, 3400, 3500, 3600, 3700, 3800, 3900]
                }
            },
            'building-b': {
                name: 'Building B',
                location: 'San Francisco, CA',
                region: 'usa',
                coordinates: [37.7749, -122.4194],
                energyOptimization: 9800,
                energySaving: 12000,
                revenue: 180000,
                revenueChange: 3.8,
                profit: 85000,
                profitChange: 5000,
                nps: 82,
                occupancy: 92,
                occupancyChange: 1.2,
                incomeData: [15000, 16000, 15500, 16500, 17000, 17500, 18000, 18500, 19000, 19500, 20000, 20500],
                costData: [9000, 9200, 9400, 9600, 9800, 10000, 10200, 10400, 10600, 10800, 11000, 11200],
                occupancyData: { occupied: 92, vacant: 8 },
                rentedByMonth: [8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30],
                availableByMonth: [3, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
                renewedContracts: [1, 2, 1, 3, 2, 2, 4, 3, 2, 1, 3, 2],
                propertyTypes: [
                    { name: "Big Studio", rented: 3, total: 5 },
                    { name: "Middle Studio", rented: 6, total: 8 },
                    { name: "Smaller Studio", rented: 8, total: 10 },
                    { name: "3 Bed Apartment", rented: 2, total: 3 },
                    { name: "2 Bed Apartment", rented: 5, total: 7 },
                    { name: "1 Bed Apartment", rented: 7, total: 9 }
                ],
                expiringLeases: [
                    { value: "$9,800", label: "< 30 Days", units: 4 },
                    { value: "$14,700", label: "31-70 Days", units: 6 },
                    { value: "$11,800", label: "61-90 Days", units: 5 }
                ],
                expiringLeasesChart: [
                    { label: "< 30 Days", value: 4, cost: 9800 },
                    { label: "31-70 Days", value: 6, cost: 14700 },
                    { label: "61-90 Days", value: 5, cost: 11800 }
                ],
                newLeads: 32,
                newLeadsChange: 3,
                leaseDuration: 28,
                utilitiesData: {
                    electricity: [4000, 4200, 3800, 4100, 4300, 4500, 4700, 4900, 5100, 5300, 5500, 5700],
                    gas: [1500, 1600, 1400, 1550, 1700, 1800, 1900, 2000, 2100, 2200, 2300, 2400],
                    water: [600, 650, 580, 620, 660, 700, 740, 780, 820, 860, 900, 940],
                    property: [2500, 2600, 2400, 2550, 2700, 2800, 2900, 3000, 3100, 3200, 3300, 3400]
                }
            }
        };

        const regionCenters = {
            'hongkong': { center: [22.3193, 114.1694], zoom: 10 },
            'mainland': { center: [35.8617, 104.1954], zoom: 4 },
            'europe': { center: [54.5260, 15.2551], zoom: 4 },
            'usa': { center: [37.0902, -95.7129], zoom: 4 }
        };

        const leaseExpiryData = [
            { name: 'John Smith', orderDate: '2023-01-15', phone: '(555) 123-4567', location: 'New York', registered: '2021-03-10' },
            { name: 'Sarah Johnson', orderDate: '2023-02-20', phone: '(555) 234-5678', location: 'San Francisco', registered: '2020-11-22' },
            { name: 'Michael Brown', orderDate: '2023-03-10', phone: '(555) 345-6789', location: 'Chicago', registered: '2019-07-15' },
            { name: 'Emily Davis', orderDate: '2023-04-05', phone: '(555) 456-7890', location: 'Los Angeles', registered: '2022-01-30' },
            { name: 'David Wilson', orderDate: '2023-05-12', phone: '(555) 567-8901', location: 'Miami', registered: '2021-09-18' },
            { name: 'Jessica Miller', orderDate: '2023-06-25', phone: '(555) 678-9012', location: 'Seattle', registered: '2020-05-05' },
            { name: 'Christopher Taylor', orderDate: '2023-07-18', phone: '(555) 789-0123', location: 'Boston', registered: '2018-12-12' },
            { name: 'Amanda Anderson', orderDate: '2023-08-30', phone: '(555) 890-1234', location: 'Austin', registered: '2022-04-22' }
        ];

        // Initialize map
        function initMap() {
            // Create map
            map = L.map('map').setView([30, 0], 2);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add markers
            Object.keys(buildingData).forEach(buildingId => {
                const building = buildingData[buildingId];

                // Create marker
                const marker = L.circleMarker(building.coordinates, {
                    color: '#2980b9',
                    fillColor: '#2980b9',
                    fillOpacity: 0.8,
                    radius: 10,
                    weight: 2
                }).addTo(map);

                // Add popup
                marker.bindPopup(`
                    <b>${building.name}</b><br>
                    ${building.location}<br>
                    Energy Optimization: ${building.energyOptimization} kWh<br>
                    Energy Saving: $${building.energySaving}
                `);

                // Store marker
                markers[buildingId] = marker;

                // Add click event
                marker.on('click', function () {
                    toggleBuildingSelection(buildingId);
                });
            });
        }

        // Update building list
        function updateBuildingList() {
            const selectedRegion = regionSelect.value;

            // Clear list
            buildingListContainer.innerHTML = '';

            // Add buildings
            Object.keys(buildingData).forEach(buildingId => {
                const building = buildingData[buildingId];

                if (selectedRegion === 'all' || building.region === selectedRegion) {
                    const buildingItem = document.createElement('div');
                    buildingItem.className = 'building-item';
                    buildingItem.dataset.buildingId = buildingId;

                    if (selectedBuildings.includes(buildingId)) {
                        buildingItem.classList.add('selected');
                    }

                    buildingItem.innerHTML = `
                        <input type="checkbox" class="building-checkbox" ${selectedBuildings.includes(buildingId) ? 'checked' : ''}>
                        <div class="building-info">
                            <div class="building-name">${building.name}</div>
                            <div class="building-location">${building.location}</div>
                        </div>
                    `;

                    // Add click event
                    buildingItem.addEventListener('click', function (e) {
                        if (e.target.type !== 'checkbox') {
                            toggleBuildingSelection(buildingId);
                        }
                    });

                    // Add checkbox event
                    const checkbox = buildingItem.querySelector('.building-checkbox');
                    checkbox.addEventListener('change', function () {
                        toggleBuildingSelection(buildingId);
                    });

                    buildingListContainer.appendChild(buildingItem);
                }
            });

            // Update count
            const regionBuildingsCount = Object.keys(buildingData).filter(id =>
                selectedRegion === 'all' || buildingData[id].region === selectedRegion
            ).length;
            totalBuildings.textContent = `${regionBuildingsCount} buildings`;
        }

        // Toggle building selection
        function toggleBuildingSelection(buildingId) {
            if (selectedBuildings.includes(buildingId)) {
                selectedBuildings = selectedBuildings.filter(id => id !== buildingId);
                markers[buildingId].setStyle({
                    fillColor: '#2980b9',
                    color: '#2980b9',
                    radius: 10
                });
            } else {
                selectedBuildings.push(buildingId);
                markers[buildingId].setStyle({
                    fillColor: '#1a3c6e',
                    color: '#1a3c6e',
                    radius: 12
                });
            }

            updateDisplay();
        }

        // Update display
        function updateDisplay() {
            // Update list styling
            document.querySelectorAll('.building-item').forEach(item => {
                const buildingId = item.dataset.buildingId;
                if (selectedBuildings.includes(buildingId)) {
                    item.classList.add('selected');
                    item.querySelector('.building-checkbox').checked = true;
                } else {
                    item.classList.remove('selected');
                    item.querySelector('.building-checkbox').checked = false;
                }
            });

            // Update energy metrics
            updateEnergyMetrics();

            // Update operations
            updateOperationsData();
        }

        // Update energy metrics
        function updateEnergyMetrics() {
            if (selectedBuildings.length === 0) {
                energyOptimization.textContent = '0 kWh';
                energyOptimizationChange.textContent = '+0 kWh vs last month';
                energySaving.textContent = '$ 0';
                energySavingChange.textContent = '+$0 vs last month';
                return;
            }

            let totalEnergyOptimization = 0;
            let totalEnergySaving = 0;

            // Calculate totals
            selectedBuildings.forEach(buildingId => {
                const building = buildingData[buildingId];
                if (building) {
                    totalEnergyOptimization += building.energyOptimization;
                    totalEnergySaving += building.energySaving;
                }
            });

            // Update metrics
            energyOptimization.textContent = `${totalEnergyOptimization.toLocaleString()} kWh`;
            energyOptimizationChange.textContent = `+${Math.round(totalEnergyOptimization * 0.1).toLocaleString()} kWh vs last month`;
            energySaving.textContent = `$ ${totalEnergySaving.toLocaleString()}`;
            energySavingChange.textContent = `+$${Math.round(totalEnergySaving * 0.1).toLocaleString()} vs last month`;
        }

        // Update operations data
        function updateOperationsData() {
            if (selectedBuildings.length === 0) {
                // Reset values
                revenueValue.textContent = '$0';
                revenueChange.textContent = '0% YoY';
                revenueChange.className = 'metric-change';

                profitValue.textContent = '$0';
                profitChange.textContent = '0 YoY';
                profitChange.className = 'metric-change';

                npsValue.textContent = '0';
                occupancyValue.textContent = '0%';
                occupancyChange.textContent = '0%';
                occupancyChange.className = 'metric-change';

                newLeads.textContent = '0';
                newLeadsChange.textContent = '0 YoY';
                newLeadsChange.className = 'metric-change';

                leaseDuration.textContent = '0 months';

                // Reset charts
                resetCharts();
                resetPropertyTypes();
                resetExpiringLeases();
                return;
            }

            // Initialize data
            let aggregatedData = {
                revenue: 0,
                revenueChange: 0,
                profit: 0,
                profitChange: 0,
                nps: 0,
                occupancy: 0,
                occupancyChange: 0,
                incomeData: Array(12).fill(0),
                costData: Array(12).fill(0),
                occupancyData: { occupied: 0, vacant: 0 },
                rentedByMonth: Array(12).fill(0),
                availableByMonth: Array(12).fill(0),
                renewedContracts: Array(12).fill(0),
                propertyTypes: [],
                expiringLeases: [],
                expiringLeasesChart: [],
                newLeads: 0,
                newLeadsChange: 0,
                leaseDuration: 0,
                utilitiesData: {
                    electricity: Array(12).fill(0),
                    gas: Array(12).fill(0),
                    water: Array(12).fill(0),
                    property: Array(12).fill(0)
                }
            };

            // Aggregate data
            selectedBuildings.forEach(buildingId => {
                const building = buildingData[buildingId];
                if (building) {
                    aggregatedData.revenue += building.revenue;
                    aggregatedData.revenueChange += building.revenueChange;
                    aggregatedData.profit += building.profit;
                    aggregatedData.profitChange += building.profitChange;
                    aggregatedData.nps += building.nps;
                    aggregatedData.occupancy += building.occupancy;
                    aggregatedData.occupancyChange += building.occupancyChange;

                    for (let i = 0; i < 12; i++) {
                        aggregatedData.incomeData[i] += building.incomeData[i];
                        aggregatedData.costData[i] += building.costData[i];
                        aggregatedData.rentedByMonth[i] += building.rentedByMonth[i];
                        aggregatedData.availableByMonth[i] += building.availableByMonth[i];
                        aggregatedData.renewedContracts[i] += building.renewedContracts[i];

                        if (building.utilitiesData) {
                            aggregatedData.utilitiesData.electricity[i] += building.utilitiesData.electricity[i];
                            aggregatedData.utilitiesData.gas[i] += building.utilitiesData.gas[i];
                            aggregatedData.utilitiesData.water[i] += building.utilitiesData.water[i];
                            aggregatedData.utilitiesData.property[i] += building.utilitiesData.property[i];
                        }
                    }

                    aggregatedData.occupancyData.occupied += building.occupancyData.occupied;
                    aggregatedData.occupancyData.vacant += building.occupancyData.vacant;

                    aggregatedData.newLeads += building.newLeads;
                    aggregatedData.newLeadsChange += building.newLeadsChange;
                    aggregatedData.leaseDuration += building.leaseDuration;
                }
            });

            // Calculate averages
            const count = selectedBuildings.length;
            aggregatedData.revenueChange = (aggregatedData.revenueChange / count).toFixed(3);
            aggregatedData.profitChange = aggregatedData.profitChange / count;
            aggregatedData.nps = Math.round(aggregatedData.nps / count);
            aggregatedData.occupancy = (aggregatedData.occupancy / count).toFixed(1);
            aggregatedData.occupancyChange = (aggregatedData.occupancyChange / count).toFixed(2);
            aggregatedData.occupancyData.occupied = Math.round(aggregatedData.occupancyData.occupied / count);
            aggregatedData.occupancyData.vacant = Math.round(aggregatedData.occupancyData.vacant / count);
            aggregatedData.newLeadsChange = aggregatedData.newLeadsChange / count;
            aggregatedData.leaseDuration = (aggregatedData.leaseDuration / count).toFixed(1);

            // Update metrics
            revenueValue.textContent = `$${aggregatedData.revenue.toLocaleString()}`;
            revenueChange.textContent = `${aggregatedData.revenueChange > 0 ? '+' : ''}${aggregatedData.revenueChange}% YoY`;
            revenueChange.className = `metric-change ${aggregatedData.revenueChange >= 0 ? 'positive' : 'negative'}`;

            profitValue.textContent = `$${aggregatedData.profit.toLocaleString()}`;
            profitChange.textContent = `${aggregatedData.profitChange > 0 ? '+' : ''}${Math.round(aggregatedData.profitChange).toLocaleString()} YoY`;
            profitChange.className = `metric-change ${aggregatedData.profitChange >= 0 ? 'positive' : 'negative'}`;

            npsValue.textContent = aggregatedData.nps;
            occupancyValue.textContent = `${aggregatedData.occupancy}%`;
            occupancyChange.textContent = `${aggregatedData.occupancyChange > 0 ? '+' : ''}${aggregatedData.occupancyChange}%`;
            occupancyChange.className = `metric-change ${aggregatedData.occupancyChange >= 0 ? 'positive' : 'negative'}`;

            newLeads.textContent = aggregatedData.newLeads;
            newLeadsChange.textContent = `${aggregatedData.newLeadsChange > 0 ? '+' : ''}${Math.round(aggregatedData.newLeadsChange)} YoY`;
            newLeadsChange.className = `metric-change ${aggregatedData.newLeadsChange >= 0 ? 'positive' : 'negative'}`;

            leaseDuration.textContent = `${aggregatedData.leaseDuration} months`;

            // Update charts
            updateCharts(aggregatedData);

            // Update property types
            updatePropertyTypes(selectedBuildings);

            // Update expiring leases
            updateExpiringLeases(selectedBuildings);

            // Update expiring chart
            updateExpiringLeasesChart(selectedBuildings);

            // Update NPS gauge
            updateNPSGaugeChart(aggregatedData.nps);

            // Update utilities chart
            updateUtilitiesChart(aggregatedData.utilitiesData);
        }

        // Reset charts
        function resetCharts() {
            if (incomeCostChart) {
                incomeCostChart.data.datasets[0].data = Array(12).fill(0);
                incomeCostChart.data.datasets[1].data = Array(12).fill(0);
                incomeCostChart.update();
            }

            if (occupancyChart) {
                occupancyChart.data.datasets[0].data = [0, 0];
                occupancyChart.update();
            }

            if (rentedByMonthChart) {
                rentedByMonthChart.data.datasets[0].data = Array(12).fill(0);
                rentedByMonthChart.data.datasets[1].data = Array(12).fill(0);
                rentedByMonthChart.update();
            }

            if (renewedChart) {
                renewedChart.data.datasets[0].data = Array(12).fill(0);
                renewedChart.update();
            }

            if (leasesExpiringChart) {
                leasesExpiringChart.data.datasets[0].data = [0, 0, 0];
                leasesExpiringChart.update();
                leasesExpiringTotal.textContent = '0';
            }

            if (npsGaugeChart) {
                npsGaugeChart.data.datasets[0].data = [0, 100];
                npsGaugeChart.update();
            }

            if (utilitiesChart) {
                utilitiesChart.data.datasets[0].data = Array(12).fill(0);
                utilitiesChart.data.datasets[1].data = Array(12).fill(0);
                utilitiesChart.data.datasets[2].data = Array(12).fill(0);
                utilitiesChart.data.datasets[3].data = Array(12).fill(0);
                utilitiesChart.update();
            }
        }

        // Reset property types
        function resetPropertyTypes() {
            const propertyTypesContainer = document.getElementById('property-types');
            propertyTypesContainer.innerHTML = '';

            const defaultTypes = [
                { name: "Big Studio", rented: 0, total: 0, percentage: 0 },
                { name: "Middle Studio", rented: 0, total: 0, percentage: 0 },
                { name: "Smaller Studio", rented: 0, total: 0, percentage: 0 },
                { name: "3 Bed Apartment", rented: 0, total: 0, percentage: 0 },
                { name: "2 Bed Apartment", rented: 0, total: 0, percentage: 0 },
                { name: "1 Bed Apartment", rented: 0, total: 0, percentage: 0 }
            ];

            defaultTypes.forEach(type => {
                const propertyBar = document.createElement('div');
                propertyBar.className = 'property-bar';
                propertyBar.innerHTML = `
                    <div class="property-bar-label">${type.name}</div>
                    <div class="property-bar-chart">
                        <div class="property-bar-fill" style="width: ${type.percentage}%"></div>
                    </div>
                    <div class="property-bar-values">${type.rented}/${type.total}</div>
                `;
                propertyTypesContainer.appendChild(propertyBar);
            });
        }

        // Reset expiring leases
        function resetExpiringLeases() {
            const expiringLeasesContainer = document.getElementById('expiring-leases');
            expiringLeasesContainer.innerHTML = '';

            const defaultLeases = [
                { value: "$0", label: "< 30 Days", units: 0 },
                { value: "$0", label: "31-70 Days", units: 0 },
                { value: "$0", label: "61-90 Days", units: 0 }
            ];

            defaultLeases.forEach(lease => {
                const leaseItem = document.createElement('div');
                leaseItem.className = 'lease-item';
                leaseItem.innerHTML = `
                    <div class="lease-value">${lease.value}</div>
                    <div class="lease-label">${lease.label}</div>
                    <div class="lease-label">${lease.units} Units</div>
                `;
                expiringLeasesContainer.appendChild(leaseItem);
            });
        }

        // Update charts
        function updateCharts(data) {
            // Income vs cost
            if (incomeCostChart) {
                incomeCostChart.data.datasets[0].data = data.incomeData;
                incomeCostChart.data.datasets[1].data = data.costData;
                incomeCostChart.update();
            }

            // Occupancy
            if (occupancyChart) {
                occupancyChart.data.datasets[0].data = [data.occupancyData.occupied, data.occupancyData.vacant];
                occupancyChart.update();
            }

            // Rented by month
            if (rentedByMonthChart) {
                rentedByMonthChart.data.datasets[0].data = data.rentedByMonth;
                rentedByMonthChart.data.datasets[1].data = data.availableByMonth;
                rentedByMonthChart.update();
            }

            // Renewed contracts
            if (renewedChart) {
                renewedChart.data.datasets[0].data = data.renewedContracts;
                renewedChart.update();
            }
        }

        // Update property types
        function updatePropertyTypes(selectedBuildings) {
            const propertyTypesContainer = document.getElementById('property-types');
            propertyTypesContainer.innerHTML = '';

            if (selectedBuildings.length === 0) {
                resetPropertyTypes();
                return;
            }

            // Initialize types
            let aggregatedTypes = {
                "Big Studio": { rented: 0, total: 0 },
                "Middle Studio": { rented: 0, total: 0 },
                "Smaller Studio": { rented: 0, total: 0 },
                "3 Bed Apartment": { rented: 0, total: 0 },
                "2 Bed Apartment": { rented: 0, total: 0 },
                "1 Bed Apartment": { rented: 0, total: 0 }
            };

            // Aggregate types
            selectedBuildings.forEach(buildingId => {
                const building = buildingData[buildingId];
                if (building && building.propertyTypes) {
                    building.propertyTypes.forEach(type => {
                        if (aggregatedTypes[type.name]) {
                            aggregatedTypes[type.name].rented += type.rented;
                            aggregatedTypes[type.name].total += type.total;
                        }
                    });
                }
            });

            // Create bars
            Object.keys(aggregatedTypes).forEach(typeName => {
                const type = aggregatedTypes[typeName];
                const percentage = type.total > 0 ? Math.round((type.rented / type.total) * 100) : 0;

                const propertyBar = document.createElement('div');
                propertyBar.className = 'property-bar';
                propertyBar.innerHTML = `
                    <div class="property-bar-label">${typeName}</div>
                    <div class="property-bar-chart">
                        <div class="property-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="property-bar-values">${type.rented}/${type.total}</div>
                `;
                propertyTypesContainer.appendChild(propertyBar);
            });
        }

        // Update expiring leases
        function updateExpiringLeases(selectedBuildings) {
            const expiringLeasesContainer = document.getElementById('expiring-leases');
            expiringLeasesContainer.innerHTML = '';

            if (selectedBuildings.length === 0) {
                resetExpiringLeases();
                return;
            }

            // Initialize leases
            let aggregatedLeases = [
                { value: 0, label: "< 30 Days", units: 0 },
                { value: 0, label: "31-70 Days", units: 0 },
                { value: 0, label: "61-90 Days", units: 0 }
            ];

            // Aggregate leases
            selectedBuildings.forEach(buildingId => {
                const building = buildingData[buildingId];
                if (building && building.expiringLeases) {
                    building.expiringLeases.forEach((lease, index) => {
                        if (aggregatedLeases[index]) {
                            const value = parseFloat(lease.value.replace(/[$,]/g, ''));
                            if (!isNaN(value)) {
                                aggregatedLeases[index].value += value;
                                aggregatedLeases[index].units += lease.units;
                            }
                        }
                    });
                }
            });

            // Create items
            aggregatedLeases.forEach(lease => {
                const displayValue = `$${lease.value.toLocaleString()}`;

                const leaseItem = document.createElement('div');
                leaseItem.className = 'lease-item';
                leaseItem.innerHTML = `
                    <div class="lease-value">${displayValue}</div>
                    <div class="lease-label">${lease.label}</div>
                    <div class="lease-label">${lease.units} Units</div>
                `;
                expiringLeasesContainer.appendChild(leaseItem);
            });
        }

        // Update expiring chart
        function updateExpiringLeasesChart(selectedBuildings) {
            if (selectedBuildings.length === 0) {
                if (leasesExpiringChart) {
                    leasesExpiringChart.data.datasets[0].data = [0, 0, 0];
                    leasesExpiringChart.update();
                    leasesExpiringTotal.textContent = '0';
                }
                return;
            }

            // Initialize data
            let aggregatedChartData = {
                "< 30 Days": { value: 0, cost: 0 },
                "31-70 Days": { value: 0, cost: 0 },
                "61-90 Days": { value: 0, cost: 0 }
            };

            // Aggregate data
            selectedBuildings.forEach(buildingId => {
                const building = buildingData[buildingId];
                if (building && building.expiringLeasesChart) {
                    building.expiringLeasesChart.forEach(item => {
                        if (aggregatedChartData[item.label]) {
                            aggregatedChartData[item.label].value += item.value;
                            aggregatedChartData[item.label].cost += item.cost;
                        }
                    });
                }
            });

            // Update chart
            if (leasesExpiringChart) {
                leasesExpiringChart.data.datasets[0].data = [
                    aggregatedChartData["< 30 Days"].value,
                    aggregatedChartData["31-70 Days"].value,
                    aggregatedChartData["61-90 Days"].value
                ];

                leasesExpiringChart.update();

                // Update total
                const totalUnits = Object.values(aggregatedChartData).reduce((sum, item) => sum + item.value, 0);
                leasesExpiringTotal.textContent = totalUnits;
            }
        }

        // Update NPS gauge
        function updateNPSGaugeChart(npsValue) {
            if (npsGaugeChart) {
                const percentage = npsValue;

                // Update data
                npsGaugeChart.data.datasets[0].data = [percentage, 100 - percentage];
                npsGaugeChart.update();

                // Update value
                npsValue.textContent = npsValue;
            }
        }

        // Update utilities chart
        function updateUtilitiesChart(utilitiesData) {
            if (utilitiesChart) {
                utilitiesChart.data.datasets[0].data = utilitiesData.electricity;
                utilitiesChart.data.datasets[1].data = utilitiesData.gas;
                utilitiesChart.data.datasets[2].data = utilitiesData.water;
                utilitiesChart.data.datasets[3].data = utilitiesData.property;
                utilitiesChart.update();
            }
        }

        // Table pagination
        function renderTablePage(page) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = leaseExpiryData.slice(startIndex, endIndex);

            // Clear table body
            leaseTableBody.innerHTML = '';

            // Add rows for current page
            pageData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.orderDate}</td>
                    <td>${item.phone}</td>
                    <td>${item.location}</td>
                    <td>${item.registered}</td>
                    <td class="action-buttons">
                        <button class="btn btn-options">Options</button>
                        <button class="btn btn-details">Details</button>
                    </td>
                `;
                leaseTableBody.appendChild(row);
            });

            // Update pagination controls
            updatePaginationControls(page);
        }

        function updatePaginationControls(currentPage) {
            const totalPages = Math.ceil(leaseExpiryData.length / itemsPerPage);

            // Clear pagination controls
            paginationControls.innerHTML = '';

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    renderTablePage(currentPage - 1);
                }
            });
            paginationControls.appendChild(prevButton);

            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.addEventListener('click', () => {
                    renderTablePage(i);
                });
                paginationControls.appendChild(pageButton);
            }

            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    renderTablePage(currentPage + 1);
                }
            });
            paginationControls.appendChild(nextButton);
        }

        // Region select event
        regionSelect.addEventListener('change', function () {
            const selectedRegion = this.value;

            // Clear selections
            selectedBuildings.forEach(buildingId => {
                markers[buildingId].setStyle({
                    fillColor: '#2980b9',
                    color: '#2980b9',
                    radius: 10
                });
            });
            selectedBuildings = [];

            // Update list
            updateBuildingList();

            // Focus map
            if (selectedRegion !== 'all' && regionCenters[selectedRegion]) {
                const region = regionCenters[selectedRegion];
                map.setView(region.center, region.zoom);
            } else {
                map.setView([30, 0], 2);
            }

            updateDisplay();
        });

        // Initialize charts
        function initOperationsCharts() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];

            // Income vs Cost Chart
            const incomeCostCtx = document.getElementById('incomeCostChart').getContext('2d');
            incomeCostChart = new Chart(incomeCostCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Rental Income',
                            data: Array(12).fill(0),
                            backgroundColor: '#4da8da',
                            borderColor: '#4da8da',
                            borderWidth: 1
                        },
                        {
                            label: 'Operating Costs',
                            data: Array(12).fill(0),
                            backgroundColor: '#1c6ea4',
                            borderColor: '#1c6ea4',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    }
                }
            });

            // Occupancy Chart
            const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
            occupancyChart = new Chart(occupancyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Occupancy', 'Vacancy'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#2980b9', '#90a4ae'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Rented by Month Chart
            const rentedByMonthCtx = document.getElementById('rentedByMonthChart').getContext('2d');
            rentedByMonthChart = new Chart(rentedByMonthCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Rented',
                            data: Array(12).fill(0),
                            backgroundColor: '#2980b9'
                        },
                        {
                            label: 'Available',
                            data: Array(12).fill(0),
                            backgroundColor: '#90a4ae'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Properties'
                            }
                        }
                    }
                }
            });

            // Renewed Contracts Chart
            const renewedCtx = document.getElementById('renewedChart').getContext('2d');
            renewedChart = new Chart(renewedCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Renewed Contracts',
                        data: Array(12).fill(0),
                        backgroundColor: '#1c6ea4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Contracts'
                            }
                        }
                    }
                }
            });

            // Leases Expiring Chart
            const leasesExpiringCtx = document.getElementById('leasesExpiringChart').getContext('2d');
            leasesExpiringChart = new Chart(leasesExpiringCtx, {
                type: 'doughnut',
                data: {
                    labels: ['< 30 Days', '31-70 Days', '61-90 Days'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4da8da', '#2980b9', '#1c6ea4'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: -90,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.parsed} units`;
                                }
                            }
                        }
                    }
                }
            });

            // NPS Gauge Chart
            const npsGaugeCtx = document.getElementById('npsGaugeChart').getContext('2d');

            // Create gradient
            const gradient = npsGaugeCtx.createLinearGradient(0, 0, 300, 0);
            gradient.addColorStop(0, '#7cb342');
            gradient.addColorStop(0.5, '#f9a825');
            gradient.addColorStop(1, '#e57373');

            npsGaugeChart = new Chart(npsGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['NPS Score', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [gradient, '#f5f5f5'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: -90,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });

            // Utilities & Services Cost Chart
            const utilitiesCtx = document.getElementById('utilitiesChart').getContext('2d');
            utilitiesChart = new Chart(utilitiesCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Electricity Bill',
                            data: Array(12).fill(0),
                            backgroundColor: '#4da8da',
                            borderColor: '#4da8da',
                            borderWidth: 1
                        },
                        {
                            label: 'Gas Bill',
                            data: Array(12).fill(0),
                            backgroundColor: '#2980b9',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        },
                        {
                            label: 'Water Bill',
                            data: Array(12).fill(0),
                            backgroundColor: '#1c6ea4',
                            borderColor: '#1c6ea4',
                            borderWidth: 1
                        },
                        {
                            label: 'Property Mgmt. Fee',
                            data: Array(12).fill(0),
                            backgroundColor: '#90a4ae',
                            borderColor: '#90a4ae',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize page
        window.onload = function () {
            initMap();
            updateBuildingList();
            initOperationsCharts();
            initEnhancedDragAndDrop();
            renderTablePage(1);
            updateDisplay();

            // Select Building A
            toggleBuildingSelection('building-a');
        };
    </script>
</body>
</html>